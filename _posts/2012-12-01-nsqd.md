--- 
title: nsqd
layout: post
category: components
permalink: /components/nsqd.html
---

`nsqd` is the daemon that receives, queues, and delivers messages to clients.

It can be run standalone but is normally configured in a cluster with `nsqlookupd` 
instance(s) (in which case it will announce topics and channels for discovery).

It listens on two TCP ports, one for clients and another for the HTTP API.

### Command Line Options

    -broadcast-address="": address that will be registered with lookupd (defaults to the OS hostname)
    -data-path="": path to store disk-backed messages
    -http-address="0.0.0.0:4151": <addr>:<port> to listen on for HTTP clients
    -lookupd-tcp-address=[]: lookupd TCP address (may be given multiple times)
    -max-body-size=5123840: maximum size of a single command body
    -max-bytes-per-file=104857600: number of bytes per diskqueue file before rolling
    -max-heartbeat-interval=1m0s: maximum client configurable duration of time between client heartbeats
    -max-message-size=1024768: maximum size of a single message in bytes
    -max-msg-timeout=15m0s: maximum duration before a message will timeout
    -max-output-buffer-size=65536: maximum client configurable size (in bytes) for a client output buffer
    -max-output-buffer-timeout=1s: maximum client configurable duration of time between flushing to a client
    -max-rdy-count=2500: maximum RDY count for a client
    -mem-queue-size=10000: number of messages to keep in memory (per topic/channel)
    -msg-timeout="60s": duration to wait before auto-requeing a message
    -statsd-address="": UDP <addr>:<port> of a statsd daemon for pushing stats
    -statsd-interval="60s": duration between pushing to statsd
    -sync-every=2500: number of messages per diskqueue fsync
    -sync-timeout=2s: duration of time per diskqueue fsync
    -tcp-address="0.0.0.0:4150": <addr>:<port> to listen on for TCP clients
    -tls-cert="": path to certificate file
    -tls-key="": path to private key file
    -verbose=false: enable verbose logging
    -version=false: print version string
    -worker-id=0: unique identifier (int) for this worker (will default to a hash of hostname)

### HTTP API

#### /put or /pub

Publish a message

Params:

    topic - the topic to publish to
    
    POST body - the raw message bytes

{% highlight bash %}
$ curl -d "<message>" http://127.0.0.1:4151/put?topic=message_topic`
{% endhighlight %}

#### /mput or /mpub

Publish multiple messages in one roundtrip

Params:

    topic - the topic to publish to
    
    POST body - `\n` separated raw messages

{% highlight bash %}
$ curl -d "<message>\n<message>\n<message>" http://127.0.0.1:4151/mput?topic=message_topic`
{% endhighlight %}

NOTE: due to the `\n` message separation, this does not currently support binary message formats

#### /create_topic

Create a topic

Params:

    topic - the topic to create

#### /delete_topic

Delete an existing topic (and all channels)

Params:

    topic - the existing topic to delete

#### /create_channel

Create a channel for an existing topic

Params:

    topic - the existing topic
    channel - the channel to create

#### /delete_channel

Delete an existing channel for an existing topic

Params:

    topic - the existing topic
    channel - the existing channel to delete

#### /empty_topic

Empty all the queued messages (in-memory and disk) for an existing topic

Params:

    topic - the existing topic to empty

#### /empty_channel

Empty all the queued messages (in-memory and disk) for an existing channel

Params:

    topic - the existing topic
    channel - the existing channel to empty

#### /pause_channel

Pause message flow to consumers of an existing channel (messages will queue)

Params:

    topic - the existing topic
    channel - the existing channel to pause

#### /unpause_channel

Resume message flow to consumers of an existing, paused, channel

Params:

    topic - the existing topic
    channel - the existing channel to pause

#### /stats

Return internal instrumented statistics

Params

    format - (optional) `text` or `json` (default = `text`)

#### /ping

Monitoring endpoint, should return `OK`

#### /info

Returns version information

### TLS

When `nsqd` is configured with `--tls-cert` and `--tls-key` clients can negotiate upgrading their
connection to TLS for enhanced security.

If you want to generate a password-less self-signed certificate using openssl:

{% highlight bash %}
$ openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 365 -nodes
{% endhighlight %}

### Statsd / Graphite Integration

When using `--statsd-address` to specify the UDP `<addr>:<port>` for
[statsd](https://github.com/etsy/statsd) (or a port of statsd like
[statsdaemon](https://github.com/bitly/statsdaemon)), `nsqd` will push metrics to statsd
periodically based on the interval specified in `--statsd-interval` (IMPORTANT: this interval should
**always** be less than or equal to the interval at which statsd flushes to graphite). With this
enabled `nsqadmin` can be configured to display charts directly from graphite.

We recommend the following configuration for graphite (but these choices should be evaluated based
on your available resources and requirements). Again, the important piece to remember is that statsd
should flush at an interval less than or equal to the smallest time bucket in `storage-schemas.conf`
and `nsqd` should be configured to flush at or below that same interval via `--statsd-interval`.

{% highlight ini %}
# storage-schemas.conf
[nsq]
pattern = ^nsq\..*
retentions = 1m:1d,5m:30d,15m:1y

# storage-aggregation.conf
[default_nsq]
pattern = ^nsq\..*
xFilesFactor = 0.2 
aggregationMethod = average
{% endhighlight %}
